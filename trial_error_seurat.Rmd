---
title: "Visium FFPE Mouse Brain Seurat"
author: "Agatha Nabilla L"
date: "5/16/2022"
output:
  html_document: default
  '"html_document"': default
---
```{r setwd, echo=FALSE, message=FALSE, warning=FALSE}
setwd("~/FFPE brain")
```

## Used Libraries 
These are used libraries on this code:
```{r libraries, echo=TRUE, message=FALSE, warning=FALSE}
library(remotes)
library(Seurat)
library(SeuratData)
library(ggplot2)
library(patchwork)
library(dplyr)
library(hdf5r)
library(shiny)
```

## Load the data 
The data are loaded with Load10X_Spatial() function to create the Seurat object 
```{r data, echo=TRUE, message=FALSE, warning=FALSE}
FFPE_brain= Load10X_Spatial("~/FFPE brain/spatial",
  filename="Visium_FFPE_Mouse_Brain_raw_feature_bc_matrix.h5", assay = "Spatial", slice = "slice2", filter.matrix = TRUE, image = NULL)

#FFPE_brain[["percent.mt"]] = PercentageFeatureSet(FFPE_brain, pattern = "^mt-")
```

## Quality control the data
The data quality checked and gene expression visualization:
```{r quality control, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE}
plot1= VlnPlot(FFPE_brain, features="nCount_Spatial") + NoLegend()
plot2= SpatialFeaturePlot(FFPE_brain, features = "nCount_Spatial") + theme(legend.position = "right")
wrap_plots(plot1, plot2)

#plot1m= VlnPlot(FFPE_brain, features="percent.mt") + NoLegend()
#plot2m= SpatialFeaturePlot(FFPE_brain, features = "percent.mt") + theme(legend.position = "right")
#wrap_plots(plot1m, plot2m)

plot1f= VlnPlot(FFPE_brain, features="nFeature_Spatial") + NoLegend()
plot2f= SpatialFeaturePlot(FFPE_brain, features = "nFeature_Spatial") + theme(legend.position = "right")
wrap_plots(plot1f, plot2f)

```
The images generated from the analysis must be in png format, otherwise it will give an error messages. Quality check is also performed on the marker genes (Ttr for the choroid plexus and Hpca is for the hippocampus):
```{r quality control marker genes, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE}
SpatialFeaturePlot(FFPE_brain, features = c("Hpca", "Ttr"))
```

```{r SCTtransform, echo=FALSE, include=FALSE, message=FALSE, warning=FALSE}
FFPE_brain_sct = SCTransform(FFPE_brain, assay="Spatial", verbose=FALSE)
```
Improve the visualization quality by changing the parameter of the spot size and the transparency.
```{r qc improving visualization, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE}
p1 = SpatialFeaturePlot(FFPE_brain, features="Ttr", pt.size.factor = 2)
p2 = SpatialFeaturePlot(FFPE_brain, features="Ttr", alpha=c(0.1,2))
p1+p2
```

## Dimensionality reduction, clustering, and visualization 
```{r dimensionality, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE}

FFPE_brain_sct = RunPCA(FFPE_brain_sct, assay="SCT", verbose = FALSE)
FFPE_brain_sct = FindNeighbors(FFPE_brain_sct, reduction="pca", dims=1:30)
FFPE_brain_sct = FindClusters(FFPE_brain_sct, verbose=FALSE)
FFPE_brain_sct = RunUMAP(FFPE_brain_sct, reduction="pca", dims=1:30)

p1r = DimPlot(FFPE_brain_sct, reduction="umap", label=TRUE)
p2r = SpatialDimPlot(FFPE_brain_sct, label = TRUE, label.size = 2)
p1r + p2r
```

## Conserved markers and Spatially variable features
```{r conserved markers, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE}

de_markers = FindMarkers(FFPE_brain_sct, ident.1 = 5, ident.2 = 6)
SpatialFeaturePlot(object = FFPE_brain_sct, features = rownames(de_markers)[1:3], alpha = c(0.1, 1), ncol = 3)

FFPE_brain_sct = FindSpatiallyVariableFeatures(FFPE_brain_sct, assay="SCT", features=VariableFeatures(FFPE_brain_sct)[1:1000],selection.method = "markvariogram")

top.features = head(SpatiallyVariableFeatures(FFPE_brain_sct, selection.method = "markvariogram"), 6)

SpatialFeaturePlot(FFPE_brain_sct, features=top.features, ncol=3, alpha=c(0.1,1))
```

## Interactive Plot 
```{r interactive plot, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE}
SpatialFeaturePlot(FFPE_brain_sct, features="Ttr", interactive = TRUE)
```

